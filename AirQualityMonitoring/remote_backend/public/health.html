<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Device Health - Air Quality Remote</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            background-color: #0f172a;
            color: #e2e8f0;
        }

        .card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>

<body class="p-6">
    <div class="max-w-3xl mx-auto">
        <header class="mb-8 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <a href="index.html"
                    class="p-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-400 transition-colors">
                    <i data-lucide="arrow-left" class="w-5 h-5"></i>
                </a>
                <div>
                    <h1 class="text-3xl font-bold text-white">Device Health</h1>
                    <p class="text-slate-400 text-sm mt-1" id="device-header">Loading...</p>
                </div>
            </div>
            <div id="connectionStatus"
                class="px-3 py-1 rounded-full text-xs font-mono bg-red-500/20 text-red-400 border border-red-500/30">
                Disconnected
            </div>
        </header>

        <!-- OTA Card (Relocated) -->
        <div id="ota-container" class="card rounded-2xl p-6 transition-all duration-300 shadow-2xl shadow-blue-500/10">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h2 class="text-xl font-semibold text-white">Firmware Update (OTA)</h2>
                    <p class="text-xs text-slate-400 mt-1">Manage device firmware remotely</p>
                </div>
                <div class="bg-blue-500/10 p-2 rounded-lg text-blue-400">
                    <i data-lucide="upload-cloud" class="w-5 h-5"></i>
                </div>
            </div>

            <!-- OTA Status/Info -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-slate-800/50 p-3 rounded-xl border border-white/5">
                    <div class="text-xs text-slate-400 mb-1">Target Version</div>
                    <div class="text-sm font-bold text-white">Latest</div>
                </div>
                <div class="bg-slate-800/50 p-3 rounded-xl border border-white/5">
                    <div class="text-xs text-slate-400 mb-1">Status</div>
                    <div class="text-sm font-bold text-slate-300" id="global-status">Idle</div>
                </div>
            </div>

            <!-- OTA Control Logic -->
            <div class="mt-3 pt-3 border-t border-white/5">
                <div class="ota-section">
                    <input type="file" id="file-input" class="hidden" accept=".bin">

                    <div id="upload-controls">
                        <button id="btn-ota"
                            class="w-full bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-xl text-sm font-medium transition-colors flex items-center justify-center gap-2 shadow-lg shadow-blue-500/20">
                            <i data-lucide="upload" class="w-4 h-4"></i> Upload Firmware
                        </button>
                    </div>

                    <div id="ota-progress" class="hidden mt-4">
                        <div class="flex justify-between text-xs text-slate-400 mb-2">
                            <span id="ota-status-text">Uploading...</span>
                            <span id="ota-percent">0%</span>
                        </div>
                        <div class="h-2 w-full bg-slate-700 rounded-full overflow-hidden">
                            <div id="ota-bar" class="h-full bg-blue-500 transition-all duration-300" style="width: 0%">
                            </div>
                        </div>
                    </div>

                    <div id="ota-message" class="mt-3 text-xs text-center hidden"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        const urlParams = new URLSearchParams(window.location.search);
        const deviceId = urlParams.get('id');

        if (!deviceId) {
            alert('No Device ID provided');
            window.location.href = 'index.html';
        }

        document.getElementById('device-header').textContent = `Device ID: ${deviceId}`;
        lucide.createIcons();

        // Elements
        const fileInput = document.getElementById('file-input');
        const otaBtn = document.getElementById('btn-ota');
        const progressDiv = document.getElementById('ota-progress');
        const bar = document.getElementById('ota-bar');
        const statusText = document.getElementById('ota-status-text');
        const percentText = document.getElementById('ota-percent');
        const otaMsg = document.getElementById('ota-message');

        // Socket Connection
        socket.on('connect', () => {
            const el = document.getElementById('connectionStatus');
            el.textContent = 'Live Connected';
            el.className = 'px-3 py-1 rounded-full text-xs font-mono bg-emerald-500/20 text-emerald-400 border border-emerald-500/30';
        });

        socket.on('disconnect', () => {
            const el = document.getElementById('connectionStatus');
            el.textContent = 'Reconnecting...';
            el.className = 'px-3 py-1 rounded-full text-xs font-mono bg-red-500/20 text-red-400 border border-red-500/30';
        });

        // OTA Progress Handling
        socket.on('ota_progress', ({ deviceId: dId, status }) => {
            if (dId !== deviceId) return;

            if (progressDiv.classList.contains('hidden')) {
                progressDiv.classList.remove('hidden');
                otaBtn.classList.add('hidden');
            }

            statusText.textContent = status.status;
            if (status.progress >= 0) {
                bar.style.width = `${status.progress}%`;
                percentText.textContent = `${status.progress}%`;
            }

            if (status.status === 'success' || status.status === 'failed') {
                if (status.status === 'success') {
                    statusText.textContent = 'OTA Success! Rebooting...';
                    statusText.classList.add('text-green-400');
                    bar.classList.add('bg-green-500');
                    bar.classList.remove('bg-blue-500');
                } else {
                    statusText.classList.add('text-red-400');
                    statusText.textContent = 'OTA Failed';
                }

                setTimeout(() => {
                    progressDiv.classList.add('hidden');
                    otaBtn.classList.remove('hidden');
                    bar.style.width = '0%';
                    statusText.classList.remove('text-green-400', 'text-red-400');
                    bar.classList.remove('bg-green-500');
                    bar.classList.add('bg-blue-500');
                }, 5000);
            }
        });

        // Upload Logic
        otaBtn.onclick = () => fileInput.click();

        fileInput.onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // UI Update
            otaBtn.classList.add('hidden');
            progressDiv.classList.remove('hidden');
            statusText.textContent = 'Uploading to Server...';
            bar.style.width = '5%';

            const formData = new FormData();
            formData.append('firmware', file);

            try {
                // 1. Upload to Backend
                const res = await fetch('/api/ota/upload', {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();

                if (data.url) {
                    statusText.textContent = 'Initiating OTA...';
                    bar.style.width = '10%';

                    // 2. Start OTA Command
                    await fetch('/api/ota/start', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            deviceId,
                            fileUrl: data.url,
                            version: 'v-new'
                        })
                    });
                }
            } catch (err) {
                console.error(err);
                statusText.textContent = 'Upload Failed';
                statusText.classList.add('text-red-400');
                setTimeout(() => {
                    progressDiv.classList.add('hidden');
                    otaBtn.classList.remove('hidden');
                }, 3000);
            }
            // Reset input
            fileInput.value = '';
        };
    </script>
</body>

</html>